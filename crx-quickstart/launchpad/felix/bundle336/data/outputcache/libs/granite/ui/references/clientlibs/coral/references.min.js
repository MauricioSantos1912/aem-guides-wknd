(function(e,h){h.References=function(){var a={},l=!1,t=e(window).adaptTo("foundation-util-paginator");a.NAMESPACE="references";a.NAMESPACE_LIST="reference-list";a.NAMESPACE_DETAIL="detail";a.SELECTOR_DETAIL=".detail";a.SELECTOR_DETAIL_TOOLBARS=".detail-toolbars";a.SELECTOR_DETAIL_LIST=".detail-list";a.EVENT_CHANGE="granite-references-change";a.EVENT_RESIZE="granite-references-resize";a.EVENT_SELECTALL="granite-references-selectall";a.SELECTION_TEXT_EMPTY=Granite.I18n.get("Select an item to display its references.");
a.SELECTION_TEXT_MULTIPLE=Granite.I18n.get("List of references is not available for multiple selection.");a.REFERENCES_UNAVAILABLE=Granite.I18n.get("List of references is not available for the selected item type.");a.init=function(){if(a.$root&&0<a.$root.length)return!0;a.$root=e("."+a.NAMESPACE);return 0<a.$root.length?(a._init(),!0):!1};a._init=function(){a.$message=a.$root.find(".message");a.$spinner=a.$root.find(".refSpinner");a.$list=a.$root.find("."+a.NAMESPACE_LIST);a.$detail=a.$root.find("."+
a.NAMESPACE_DETAIL);a.$detailHeader=a.$detail.find(".detail-header");a.$detailList=a.$detail.find(".detail-list");a.$detailToolbars=a.$detail.find(".detail-toolbars");a.formerToolbarHeightCounter=0;a.formerToolbarHeight=0;a.handlers={};a.triggerChange=function(b){a.$root.trigger(a.EVENT_CHANGE+"."+a.NAMESPACE,b)};a.triggerResize=function(b){a.$root.trigger(a.EVENT_RESIZE,b)};a.hideSpinner=function(){a.$spinner.hide()};a.showSpinner=function(){a.$message.hide();a.$spinner.show()};a.showPanel=function(b){a.$message.toggle(a.$message.hasClass(b));
a.$list.toggle(a.$list.hasClass(b));a.$spinner.toggle(a.$spinner.hasClass(b));a.$detail.toggle(a.$detail.hasClass(b)).find(".actions").hide();"detail"!==b?(a.$root.data("type",""),a.$root.find(".granite-references-item--back").hide()):a.$root.find(".granite-references-item--back").show()};a.displayMessage=function(b){a.hideSpinner();a.$message.html(b);a._resetContainers()};a._resetContainers=function(){a.$list.find("section").each(function(){var b=e(this);b.find(".detail-references").val("");var c=
b.find("\x3e .info a"),d=c.text();0<d.length&&")"===d.charAt(d.length-1)&&(d=d.substr(0,d.lastIndexOf(" ")));c.text(d+" (0)");b.find("coral-icon").attr("hidden",!0)});a.showPanel("message")};a.clearPaginator=function(b){(b=b.paginator)&&b.destroy()};a.setPaginator=function(b){var c=parseInt(b.data("limit"))||100,d=new t({el:b[0],limit:c,wait:function(){a.showSpinner();return{clear:function(){a.hideSpinner()}}},resolveURL:function(f){var g=Granite.HTTP.externalize(a.$root.data("componentPath")+".provider.html?"),
k=new URLSearchParams;k.append("item",a.getReferencePaths()[0]);k.append("acceptType",b.find("section:eq(0)").data("type"));k.append("offset",f.offset);return g+k},processResponse:function(f,g){a.showSpinner();var k=e.Deferred(),m=Granite.UI.Foundation.Utils.processHtml(g,void 0,function(){var p=e("\x3cdiv\x3e"+m+"\x3c/div\x3e").find("section"),q=a.$detailList.html(),r=0;p.each(function(u,n){""!=n.dataset.hasmore&&(e(n).find(".actions").hide(),q+=n.outerHTML,r++)});a.$detailList.html(q);a.updateDetailListAccessibility();
a.hideSpinner();k.resolve({length:r,hasNext:p.length>=f.limit})});return k.promise()}});b.paginator=d;d.start(c)};a.appendReference=function(b){var c=e(b);if(c.data("type")){var d=""===c.data("hasmore");c=a.$list.find("section."+c.data("type"));var f=e(c.find(".detail-references")),g=f.val()+b.outerHTML;f.val(g);b=c.find("\x3e .info a");g=g.match(/<section/g);f=b.text();0<f.length&&")"===f.charAt(f.length-1)&&(f=f.substr(0,f.lastIndexOf(" ")));var k=g=d?g.length-1:g.length;d&&(k+="+");b.text(f+" ("+
k+")");g?c.find("coral-icon").removeAttr("hidden"):c.find("coral-icon").attr("hidden",!0)}};a.setToolbars=function(b,c){b&&c&&(c=a.$list.find("section."+c),c=e(c.find(".detail-toolbars")),b&&"string"===typeof b?c.val(b):c.val(""))};a.setReferencePaths=function(b){"undefined"===typeof b&&(b=e(a.$root.data("target")));var c=b.find(".foundation-selections-item");if(0===c.length)b.is(".foundation-layout-list")?a.triggerChange():a.triggerChange({paths:[]});else{var d=[];c.each(function(){d.push(e(this).data("foundation-collection-item-id"))});
b=a.$root.data("paths")?a.getReferencePaths():[];a.triggerChange({paths:d,avoidRefresh:1<d.length&&1<b.length})}};a.getReferencePaths=function(){return a.$root.data("paths")?a.$root.data("paths").split("|"):[]};a.getReferencePath=function(){var b=a.getReferencePaths();return 0<b.length?b[0]:void 0};a.checkHasSingleValidReferencePath=function(b){if(0===b.length||1===b.length&&""===b[0])a.displayMessage(a.SELECTION_TEXT_EMPTY);else if(1<b.length)a.displayMessage(a.SELECTION_TEXT_MULTIPLE);else if(0==
e(".foundation-selections-item").data("references"))a.displayMessage(a.REFERENCES_UNAVAILABLE);else return!0};a.refreshDetail=function(){var b=a.$root.data("type");a.requestReferences(function(){a.loadDetail(b)})};a.refreshDetailSection=function(b){var c=a.getReferencePaths();a.checkHasSingleValidReferencePath(c)&&e.ajax({url:Granite.HTTP.externalize(a.$root.data("componentPath")+".provider.html"),data:{item:c[0]},cache:!1}).done(function(d){a._resetContainers();var f=a.$detailList.find("section.active"),
g=f.data("path");a.$detailList.empty();e(d).each(function(){e(this).data("type")===b&&(a.$detailList.append(e(this)),e(this).data("path")===g&&(f=e(this)))});a.showPanel("detail");a.triggerResize({detail:!0});f.trigger("click")}).fail(function(){a.displayMessage("An error occurred while refreshing list of references.")})};a.$root.on(a.EVENT_CHANGE+"."+a.NAMESPACE,function(b,c){b=[];c=c||{};c.paths&&(b=c.paths);if(1===b.length)a.$root.data("paths",b[0]);else if(0===b.length)a.$root.data("paths","");
else{var d="",f="",g;for(g in b)d+=f+b[g],f="|";a.$root.data("paths",d)}a.$root.is(":visible")&&!c.avoidRefresh&&a.$root.hide().fadeIn("fast").trigger(a.EVENT_CHANGE+"."+a.NAMESPACE+"-"+a.NAMESPACE_LIST)});a.$root.on(a.EVENT_CHANGE+"."+a.NAMESPACE+"-"+a.NAMESPACE_LIST,function(){a.requestReferences(function(){a.requestToolbars(function(){a.showPanel("reference-list");e("ul.reference-list li:not([aria-hidden]) section.granite-references-item").each(function(b,c){var d=(b=e(c).find("a.granite-references-title").text())&&
b.endsWith("(0)"),f=e(c).parent().children()[0].id;e(c).parent().attr("aria-labelledby",f);d?(e(c).css("cursor","auto"),e(c).attr("aria-disabled","true"),e(c).removeAttr("tabindex"),e(c).removeAttr("aria-haspopup")):(e(c).css("cursor","pointer"),e(c).removeAttr("aria-disabled"),e(c).attr("tabindex","0"),e(c).attr("aria-haspopup","dialog"));b&&e(c).attr("aria-label",b)});e("ul.reference-list li:not([aria-hidden]) section.granite-references-item[tabindex]").first().focus();a.triggerResize({list:!0,
scrollToTop:!0})})})});a.requestReferences=function(b){a.showSpinner();var c=a.getReferencePaths();a.checkHasSingleValidReferencePath(c)&&e.ajax({url:Granite.HTTP.externalize(a.$root.data("componentPath")+".provider.html"),data:{item:c[0]},cache:!1}).done(function(d){a._resetContainers();a.$list.find("section .detail-references").val("");e(d).each(function(){a.appendReference(this)});a.hideSpinner();"undefined"!=typeof b&&b()}).fail(function(){a.displayMessage("An error occurred while refreshing list of references.")})};
a.requestToolbars=function(b){a.showSpinner();var c=a.getReferencePaths();a.checkHasSingleValidReferencePath(c)&&e.ajax({url:Granite.HTTP.externalize(a.$root.data("componentPath")+".html"+c[0]),cache:!1}).done(function(d){a.$list.find("section .detail-toolbars").val("");e(d).find(".granite-references-item[data-type]").each(function(){var f=e(this).data("type"),g=e(this).find(".detail-toolbars").val().trim();g&&a.setToolbars(g,f)});a.hideSpinner();"undefined"!=typeof b&&b()}).fail(function(){a.displayMessage("An error occurred while refreshing list of references.")})};
a.$list.on("click","section",function(){a.loadDetail(e(this))});a.$list.on("focus","section.granite-references-item[tabindex]:not([aria-disabled])",function(b){a.$list.find(b.handleObj.selector).not(b.currentTarget).attr("tabindex","-1");b.currentTarget.tabIndex=0});a.listKeydownEventHandler=function(b){var c=b.keyCode;if(13===c||32===c)b.preventDefault(),b.currentTarget.click();else if(33>c||40<c)return;var d=e(b.delegateTarget).find(b.handleObj.selector),f=d.length,g=d.index(b.currentTarget);b.preventDefault();
b.stopPropagation();switch(c){case 40:case 33:g<f-1&&d[g+1].focus();break;case 38:case 34:0<g&&d[g-1].focus();break;case 35:d[f-1].focus();break;case 36:d[0].focus();break;case 37:"true"===b.currentTarget.getAttribute("aria-expanded")?b.currentTarget.click():"false"===b.currentTarget.getAttribute("aria-expanded")&&a.$root.find(".granite-references-item--back").click();break;case 39:b.currentTarget.click()}};a.$list.on("keydown","section.granite-references-item[tabindex]:not([aria-disabled])",a.listKeydownEventHandler);
a.loadDetail=function(b){b="string"===typeof b?a.$list.find("section."+b):b;var c=b.find(".detail-references").val(),d=""===c.trim();if(!d||!0===b.data("showemptydetail")){a.$root.data("type",b.data("type"));var f=b.find("\x3e .info a").text();f=null==f?"":f.match(/.*[^ (\d)+]/)[0];!0!==b.data("multiselect")||d?(a.$detailHeader.removeClass("granite-references-detail-item--hasCheckbox"),a.$detailHeader.text(f)):(a.$detailHeader.addClass("granite-references-detail-item--hasCheckbox").html("\x3ccoral-checkbox\x3e"+
f+"\x3c/coral-checkbox\x3e"),a.$detailHeader.find("coral-checkbox").on("change",function(){var g=this.checked;0===a.$detailList.find("section coral-checkbox").length&&e(a.$detailList.find("section")).addClass("granite-references-detail-item--hasCheckbox").prepend("\x3ccoral-checkbox\x3e\x3c/coral-checkbox\x3e");e(a.$detailList.find("section.active")).removeClass("active").find(".actions").hide();a.$detailList.find("section").toggleClass("granite-references-detail-item--hasCheckbox",g).find("coral-checkbox").each(function(){e(this).toggle(g);
Coral.commons.ready(this,function(k){k.indeterminate=!1;k.checked=g})});a.$detailList.data("multiselect",g);a.$root.trigger(a.EVENT_SELECTALL,{checked:g})}));a.$detailList.html(c);a.updateDetailListAccessibility();a.$detailToolbars.html(b.find(".detail-toolbars").val());a.clearPaginator(a.$detailList);b=a.$detailList.find("section[data-hasmore]");0<b.length&&(b.remove(),a.setPaginator(a.$detailList));a.showPanel("detail");a.$detail.trigger("foundation-contentloaded.data-api");window.setTimeout(function(){a.triggerResize({detail:!0,
scrollToTop:!0})},1);e(a.$detailToolbars.find(".detail-toolbar coral-accordion")).on("coral-accordion:change",function(g,k){var m=window.setInterval(function(){a.triggerResize({detail:!0,interval:m})},10)});setTimeout(function(){a.$root.find(".granite-references-item--back button").focus();a.$detailList.find(".granite-references-item \x3e .info[role\x3dbutton][tabindex\x3d0]").first().focus()},50)}};a.updateDetailListAccessibility=function(){a.$detailHeader.prop("id")||a.$detailHeader.prop("id",Coral.commons.getUID());
a.$detailList.attr({role:"list","aria-labelledby":a.$detailHeader.prop("id")});var b=a.$detailList.find("section");b.each(function(c,d){d=e(d);var f=d.find("div.info"),g=d.find("div.actions");g.prop("id")||g.prop("id",Coral.commons.getUID());d.attr({role:"listitem","aria-posinset":c+1,"aria-setsize":b.length});f.attr({role:"button",tabindex:"0","aria-expanded":"false","aria-controls":g.prop("id")})})};a.updateMainCheckbox=function(){var b=!1,c=!1;a.$detailList.find("coral-checkbox").each(function(){this.checked?
b=!0:c=!0;if(b&&c)return!1});var d=a.$detailHeader.find("coral-checkbox").get(0);b&&c?(d.checked=!1,d.indeterminate=!0):(d.checked=b,d.indeterminate=!1)};a.$root.on("click",".granite-references-item--back",function(){a.showPanel("reference-list");a.$detailList.removeData("multiselect");a.$list.find("section.granite-references-item[tabindex\x3d0]:not([aria-disabled])").focus()});a.$detailList.on("click","section",function(b){var c=e(this),d=c.find(".actions");!d.length||d.is(b.target)||e.contains(d[0],
b.target)||(!0===a.$detailList.data("multiselect")?(d=c.find("coral-checkbox").get(0),c=c.find("coral-checkbox input"),d&&(d.checked=c.is(b.target)?c.prop("checked"):!d.checked,a.updateMainCheckbox())):(c.toggleClass("active"),c.hasClass("active")?c.find(".info").attr("aria-expanded","true"):c.find(".info").attr("aria-expanded","false"),d.toggle(),c.siblings("section").removeClass("active").find(".actions").hide(),b.preventDefault()))});a.$detailList.on("keydown","section.granite-references-item \x3e .info[tabindex]",
a.listKeydownEventHandler);a.$root.on(a.EVENT_RESIZE,function(b,c){c=c||{};c.detail||c.list||(c.detail=!0,c.list=!0);!0===c.list&&(a.$list.height(e(window).height()-a.$list.offset().top),!0===c.scrollToTop&&a.$list.scrollTop(0));if(!0===c.detail){b=a.$detailToolbars.find(".detail-toolbar.active");var d=0;b&&(c.interval||0!==b.find("coral-accordion-item[selected]").length?d=b.outerHeight():(b.find("coral-accordion-item coral-accordion-item-content").hide(),d=b.outerHeight(),b.find("coral-accordion-item coral-accordion-item-content").show()));
c.interval&&d===a.formerToolbarHeight?3===a.formerToolbarHeightCounter?(window.clearInterval(c.interval),a.formerToolbarHeightCounter=0):a.formerToolbarHeightCounter++:(a.formerToolbarHeight=d,a.formerToolbarHeightCounter=0,a.$detailList.height(e(window).height()-a.$detailList.offset().top-d),!0===c.scrollToTop&&a.$detailList.scrollTop(0))}});l=!0;a.setReferencePaths();e(document).trigger("granite-references-ready"+a.NAMESPACE)};a.ready=function(b){if(l)b();else e(document).on("granite-references-ready"+
a.NAMESPACE,b)};a.init();return a}()})(jQuery,Granite);(function(e,h){h.ready(function(){e(document).on("foundation-selections-change",function(a){h.setReferencePaths(e(a.target))})})})(jQuery,Granite.References);(function(e,h){function a(){!0!==h.init()&&window.setTimeout(a,10)}e(document).on("foundation-toggleable-show",function(l){e(l.target).hasClass("cq-rail-references")&&(!0===h.init()?h.$root.trigger(h.EVENT_CHANGE+"."+h.NAMESPACE+"-"+h.NAMESPACE_LIST):a())})})(jQuery,Granite.References);
(function(e,h){h.ready(function(){$(window).on("resize",function(a){a.originalEvent&&"resize"===a.originalEvent.type&&h.triggerResize()})})})(jQuery,Granite.References);
(function(e,h){h.ready(function(){h.$root.on("click",".granite-Reference-Action.granite-Reference-Action--reveal",function(){var a=e(this).closest("section"),l=h.$root.data("adminurl");a.data("path")&&a.data("parentPath")&&""!==l&&"null"!==(new URL(l,document.baseURI)).origin&&(window.location=Granite.HTTP.externalize(l)+a.data("parentPath"))})})})(jQuery,Granite.References);