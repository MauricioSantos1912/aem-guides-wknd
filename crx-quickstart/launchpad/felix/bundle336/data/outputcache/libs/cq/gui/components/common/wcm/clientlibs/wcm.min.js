(function(window,document,Granite,$){$(document).on("foundation-contentloaded",function(e){if(window.location.hash&&window.location.hash!==""){var doc=$(document),path=window.location.hash.substring(1),$item=$('.foundation-collection-item[data-path\x3d"'+path+'"]');if($item.length>0){$(doc).trigger("foundation-mode-change",["selection","cq-siteadmin-admin-childpages"]);if(CUI&&CUI.ColumnView&&$.cookie("cq.sites.childpages.layoutId")==="columns"){var columnView=$(".foundation-collection").data("foundation-layout-columns.internal.ColumnView");
if(columnView)$(".coral-ColumnView-icon",$item).click()}else{var foundationSelections=$(".foundation-collection").adaptTo("foundation-selections");foundationSelections.select($item)}}window.location.hash=""}})})(window,document,Granite,Granite.$);
(function(window,document,Granite,$){var OT_ASSETS_ASYNC_COPY="OT_ASSETS-24764";var NUMBER_ASSETS_COPY=5;var ASYNC_COPY_NUMBER_OF_ASSETS=100;var COMMAND_URL=Granite.HTTP.externalize("/bin/wcmcommand");var ids=null;var isBulkCopy=false;var sourceParentPath=null;var exceptPath=[];var destText="Paste";var createDialogEl;var relPasteDialog=".cq-siteadmin-admin-pastepagedialog";var pasteActivator=".cq-wcm-paste-activator";var formFieldWrapper=" coral-Form-fieldwrapper";var formFieldLabel=" coral-Form-fieldlabel";
function createEl(name){return $(document.createElement(name))}function closeBrowserWarning(){return Granite.I18n.get("Paste operation is in progress. Refreshing page may cause unexpected results.")}function updatePasteButton(context){context=context||document;var pasteButton=$(pasteActivator,context);toggleButton(pasteButton)}function updateSitesPasteButton(context){context=context||document;var sitesPasteButton=$(".cq-wcm-sites-paste-activator",context);toggleButton(sitesPasteButton)}function toggleButton(button){if(!ids)button.attr("hidden",
"hidden");else button.removeAttr("hidden")}function getDestPath(activator){var dest=activator.data("cqWcmPasteActivatorDest");if(dest)return dest;var target=activator.data("cqWcmPasteActivatorTarget");if(!target)return;var collection=$(target);if(!collection.hasClass("foundation-collection"))return;if(collection.hasClass("foundation-layout-columns")){var columns=collection.children(".coral-ColumnView-column");if(columns.filter(".is-active").length===0){var first=columns.first().find(".foundation-collection-item").first();
if(first.length>0){var id=first.data("foundationCollectionItemId");var parts=id.split("/");parts.pop();return parts.join("/")}}else return collection.data("foundationCollectionId")}else return collection.data("foundationCollectionId")}function getPasteDestination(activator){destText="Paste Page In "+getDestPath(activator);return destText}function triggerPasteCompletionEvent(args,params){if(!Granite.Toggles.isEnabled(OT_ASSETS_ASYNC_COPY))if($.isArray(args[0]))for(var i=0;i<args.length;i++)params[i].destPath=
$(args[i][0]).find("#Message").html();else params[0].destPath=$(args[0]).find("#Message").html();$(document).trigger("cq-wcm-paste-completed",[params])}$(window).adaptTo("foundation-registry").register("foundation.collection.action.action",{name:"cq.wcm.copy",handler:function(name,el,config,collection,selections){ids=selections.map(function(v){return $(v).data("foundationCollectionItemId")});if(!ids.length)return;isBulkCopy=config&&config.target&&config.activeSelectionCount==="bulk"&&collection&&
collection.dataset&&collection.dataset.foundationSelectionsSelectallMode==="true";if(isBulkCopy){$(collection).find(".foundation-collection-item:not(.foundation-selections-item)").each(function(){var itemPath=this.dataset.foundationCollectionItemId;if(itemPath)exceptPath.push(itemPath)});sourceParentPath=collection.dataset.foundationCollectionId}updateSitesPasteButton();if($("button.cq-siteadmin-admin-pastepagedialog.cq-wcm-sites-paste-activator",document).length!==0){if(createDialogEl)createDialogEl=
null;initPasteDialog()}updatePasteButton();$(collection).adaptTo("foundation-selections").clear()}});function getOutputData(source,destination,isShallow){return{srcPath:source,destParentPath:destination,before:"",shallow:isShallow}}function getBulkCopyAssetPromise(activator,destParentPath){var selector=activator.hasClass("cq-damadmin-admin-pasteasset")?"bulkassets":"bulkpages";return $.post(sourceParentPath+"."+selector+".copy",{sourceParentPath:sourceParentPath,destParentPath:destParentPath,exceptPath:exceptPath})}
function getUpdatedDestParentPath(v,destParentPath){var relativeTemplateParent="settings/wcm/templates";if(v.indexOf("/conf")===0&&v.indexOf(relativeTemplateParent)>=0&&destParentPath.indexOf(relativeTemplateParent)===-1)destParentPath+="/"+relativeTemplateParent;return destParentPath}function getDefaultCopyAssetPromise(source,destination,isShallow,newSiteName){return $.ajax({url:COMMAND_URL,type:"POST",data:{_charset_:"UTF-8",cmd:"copyPage",srcPath:source,destParentPath:destination,before:"",destName:newSiteName,
shallow:isShallow}})}function showCopyErrorDialog(message){var $errDialog=$("copyErrorDialog");var errDialog;if($errDialog.length<=0){errDialog=(new Coral.Dialog).set({id:"copyErrorDialog",variant:"error",header:{innerHTML:Granite.I18n.get("Error")},content:{innerHTML:$("\x3cp\x3e\x3c/p\x3e").text(message)[0].outerHTML},footer:{innerHTML:$('\x3cbutton is\x3d"coral-button" variant\x3d"primary" '+'coral-close size\x3d"M"\x3e\x3c/button\x3e').text(Granite.I18n.get("Ok"))[0].outerHTML}});document.body.appendChild(errDialog)}else errDialog=
$errDialog[0];errDialog.show()}function asyncCopy(destParentPath,ui){$.ajax({url:"/bin/asynccommand",type:"post",data:{force:true,_charset_:"UTF-8",operation:"COPY",optype:"copy",sourceParentPath:ids,destParentPath:destParentPath,exceptPath:exceptPath,description:"Copying "+ids+" to "+destParentPath},success:function(){var successMessage=Granite.I18n.get("Your copy job has been initiated. You will be notified on successful completion.");ui.prompt(Granite.I18n.get("Success"),successMessage,"success",
[{text:Granite.I18n.get("OK"),primary:true}])},error:function(response){ui.clearWait();showCopyErrorDialog(Granite.I18n.get("Failed to copy - {}",response.statusText))}})}function initPasteDialog(){var pasteDialog=(new PasteDialog).set("pastePage",document.querySelector(relPasteDialog));pasteDialog.initialize()}$(document).on("click",pasteActivator,function(e){e.preventDefault();var activator=$(this);return performPaste(activator,false)});function getAssetAndFolderCount(){var count=0;$.ajax({async:false,
url:Granite.HTTP.externalize("/bin/numberofentitiesinfolders.json"),type:"POST",data:{"folderpaths":ids},success:function(response){count=response.entitycount},error:function(){count=0}});return count}function hasBulkCopy(){var count=getAssetAndFolderCount();return count>=NUMBER_ASSETS_COPY}function isBulkShallowCopy(isShallow){if(isBulkCopy&&sourceParentPath&&!isShallow)return true;return hasBulkCopy()}function asyncOrSyncPaste(promises,outputParams,ui,destParentPath,activator,isShallow,newSiteName){if(Granite.Toggles.isEnabled(OT_ASSETS_ASYNC_COPY)&&
isAssetCopy()&&(isBulkShallowCopy(isShallow)||ids.length>=ASYNC_COPY_NUMBER_OF_ASSETS))asyncCopy(destParentPath,ui);else if(isBulkCopy&&sourceParentPath&&!isShallow){promises.push(getBulkCopyAssetPromise(activator,destParentPath));outputParams.push(getOutputData(sourceParentPath,destParentPath,false))}else ids.forEach(function(pathToCopy){var updatedDestParentPath=getUpdatedDestParentPath(pathToCopy,destParentPath);promises.push(getDefaultCopyAssetPromise(pathToCopy,updatedDestParentPath,isShallow,
newSiteName));outputParams.push(getOutputData(pathToCopy,updatedDestParentPath,isShallow))})}function isAssetCopy(){var isAssetCopy=true;ids.forEach(function(id){if(!id.startsWith("/content/dam"))isAssetCopy=false});return isAssetCopy}function performPaste(activator,isShallowCopy,newSiteName){var destParentPath=getDestPath(activator);if(!destParentPath)return;var ui=$(window).adaptTo("foundation-ui");ui.wait();$(window).on("beforeunload",closeBrowserWarning);var promises=[];var outputParams=[];var isShallow=
isShallowCopy;asyncOrSyncPaste(promises,outputParams,ui,destParentPath,activator,isShallow,newSiteName);$.when.apply(null,promises).always(function(){$(window).off("beforeunload",closeBrowserWarning);ui.clearWait()}).done(function(){triggerPasteCompletionEvent(arguments,outputParams);var target=activator.data("cqWcmPasteActivatorTarget");if(target){var api=$(target).adaptTo("foundation-collection");if(api&&"reload"in api){api.reload();return}}var contentApi=$(".foundation-content").adaptTo("foundation-content");
if(contentApi)contentApi.refresh()}).fail(function(xhr){if(xhr.status===0||xhr.readyState===0)return;var title=Granite.I18n.get("Error");var message=Granite.I18n.getVar($(xhr.responseText).find("#Message").html());ui.alert(title,message,"error")})}$(document).on("foundation-contentloaded",function(e){updateSitesPasteButton(e.target);updatePasteButton(e.target)});$(window).adaptTo("foundation-registry").register("foundation.collection.action.action",{name:"cq.wcm.paste.shallow",handler:function(name,
el,config,collection,selections){var control=$(el);var nesting=config.data.nesting;if(nesting==="hide"){var parentAPI=control.closest(".foundation-toggleable").adaptTo("foundation-toggleable");if(parentAPI)parentAPI.hide()}var activator=$(pasteActivator);if(activator.length>0)performPaste(activator,true)}});var PasteDialog=new Class({pastePage:null,dialog:null,_ALLOWED_FILENAME_CHARS:/^[a-zA-Z0-9_\-,]+$/,set:function(prop,value){this[prop]=value;return this},initialize:function(){var self=this;$("._coral-BaseOverlay,._coral-Dialog-wrapper").remove();
if(!self.dialog){self.dialog=self.createDialog();document.body.appendChild(self.dialog)}var activator=$(relPasteDialog);var destination=getPasteDestination(activator);self.dialog.getElementsByTagName("coral-dialog-header")[0].innerHTML=destination;Coral.commons.ready(self.pastePage,function(){self.pastePage.on("click",function(){var parentAPI=$(self.pastePage).closest(".foundation-toggleable").adaptTo("foundation-toggleable");if(parentAPI)parentAPI.hide();self._cleanDialog();self.dialog.show()})})},
createCopiedFromField:function(contentForm){contentForm.appendChild(function(){var fieldDiv=document.createElement("div");var titleLabel=document.createElement("label");fieldDiv.className+=formFieldWrapper;titleLabel.innerHTML=Granite.I18n.get("Copied From");titleLabel.className+=formFieldLabel;fieldDiv.appendChild(titleLabel);var valueCopiedFrom=createEl("P").appendTo(fieldDiv);var copiedFrom=ids[0];copiedFrom=copiedFrom.substr(0,copiedFrom.lastIndexOf("/"));valueCopiedFrom.text(copiedFrom);return fieldDiv}())},
createNewSiteName:function(contentForm,dialog){var self=this;var newSiteName;contentForm.appendChild(function(){var fieldDiv=document.createElement("div");var titleLabel=document.createElement("label");fieldDiv.className+=formFieldWrapper;titleLabel.innerHTML=Granite.I18n.get("New Site Name *");titleLabel.className+=formFieldLabel;var input=(new Coral.Textfield).set({name:":name"}).on("input",function(){newSiteName=$(this).get(0);self._validateAndAddTooltip(newSiteName.value)}).on("keypress",function(event){var charCode=
event.which||event.keyCode;if(charCode===13){event.preventDefault();self._submit()}});input.className+=" coral-Form-field";input.placeholder=ids[0].substring(ids[0].lastIndexOf("/")+1);dialog.nameInput=input;fieldDiv.appendChild(titleLabel);fieldDiv.appendChild(input);return fieldDiv}())},pasteFiles:function(contentForm){contentForm.appendChild(function(){var fieldDiv=document.createElement("div");var titleLabel=document.createElement("label");fieldDiv.className+=formFieldWrapper;titleLabel.innerHTML=
Granite.I18n.get("Pasting Files");titleLabel.className+=formFieldLabel;fieldDiv.appendChild(titleLabel);var list=[];var maxCount=Math.min(ids.length,12);for(var i=0,ln=maxCount;i<ln;i++){var fileName=ids[i].substring(ids[i].lastIndexOf("/")+1);list.push(createEl("span").text(fileName).prop("outerHTML"))}if(ids.length>maxCount)list.push("\x26#8230;");createEl("p").html(list.join("\x3cbr\x3e")).appendTo(fieldDiv);return fieldDiv}())},createDialog:function(){var self=this;var activator=$(relPasteDialog);
var dialogExists=false;if(!createDialogEl){dialogExists=true;createDialogEl=(new Coral.Dialog).set({id:"pastePageDialog",header:{innerHTML:getPasteDestination(activator)},closable:"on"})}var dialog=createDialogEl;var content=dialog.content;var contentForm;if(dialogExists){contentForm=content.appendChild(document.createElement("form"));contentForm.className+=" coral-Form--vertical";if(ids.length===1)this.createNewSiteName(contentForm,dialog);this.createCopiedFromField(contentForm);this.pasteFiles(contentForm);
var shallowPaste=(new Coral.Checkbox).on("change",function(){dialog.shallowPaste=this.checked});shallowPaste.label.innerHTML=Granite.I18n.get("Paste Without Children");$(shallowPaste).addClass("shallow-paste-checkbox");contentForm.appendChild(shallowPaste);var footer=dialog.footer;var cancel=new Coral.Button;cancel.label.textContent=Granite.I18n.get("Cancel");footer.appendChild(cancel).on("click",function(){self._cleanDialog();dialog.hide()});var submitButton=(new Coral.Button).set({variant:"primary"}).on("click",
function(){self._submit()});submitButton.label.textContent=Granite.I18n.get("Paste");footer.appendChild(submitButton);dialog.shallowPaste=false}return dialog},_validateAndAddTooltip:function(enteredText){var self=this;Array.prototype.slice.call(self.dialog.nameInput.parentElement.getElementsByClassName("error-info-icon")).forEach(function(item){item.remove()});if(self._hasRestrictedChar(enteredText)){var errorIcon=(new Coral.Icon).set({id:"new-site-name-textfield-fielderror",icon:"infoCircle",size:"S"});
errorIcon.className+=" coral-Form-fieldinfo error-info-icon";self.dialog.nameInput.parentElement.appendChild(errorIcon);var errorTooltip=(new Coral.Tooltip).set({content:{innerHTML:Granite.I18n.get("The name must use characters matching the following regular expression {0}. Invalid characters were replaced by {1}",[self._getValidCharSet(),"-"])},variant:"inspect",target:"#new-site-name-textfield-fielderror",placement:"left",id:"new-site-name-textfield-fielderror-tooltip"});self.dialog.nameInput.parentElement.appendChild(errorTooltip);
var validValue=self._replaceRestrictedCodes(enteredText).replace(/ /g,"-");self.dialog.nameInput.value=validValue}else self.dialog.nameInput.value=enteredText.replace(/ /g,"-")},_getValidCharSet:function(){var self=this;return self._ALLOWED_FILENAME_CHARS.toString()},_cleanDialog:function(){var self=this;$.each(self.dialog.getElementsByTagName("input"),function(cnt,input){if(input.type==="text")input.value="";else if(input.type==="checkbox")input.checked=false});Array.prototype.slice.call(self.dialog.getElementsByClassName("error-info-icon")).forEach(function(item){item.remove()});
self.dialog.shallowPaste=false},_isRestricted:function(code){var charVal=String.fromCharCode(code);return!charVal.match(this._ALLOWED_FILENAME_CHARS)},_hasRestrictedChar:function(textValue){var self=this;for(var i=0,ln=textValue.length;i<ln;i++)if(self._isRestricted(textValue.charCodeAt(i)))return true;return false},_replaceRestrictedCodes:function(name){var self=this;var jcrValidName="";for(var i=0,ln=name.length;i<ln;i++)if(self._isRestricted(name.charCodeAt(i)))jcrValidName+="-";else jcrValidName+=
name[i];return jcrValidName},_submit:function(){var self=this;var activator=$(relPasteDialog);if(ids.length===1)performPaste(activator,self.dialog.shallowPaste,self.dialog.nameInput.value);else performPaste(activator,self.dialog.shallowPaste);self._cleanDialog();self.dialog.hide()}});$(document).on("click",".cq-siteadmin-admin-pastepagedialog",initPasteDialog)})(window,document,Granite,Granite.$);
(function(window,document,$,URITemplate){var modal="#create-folder-modal";var actionPath=null;$(window).adaptTo("foundation-registry").register("foundation.collection.action.action",{name:"cq.wcm.createfolder",handler:function(name,el,config,collection,selections){if(!selections.length)return;actionPath=URITemplate.expand(config.data.action,{item:$(selections[0]).data("foundationCollectionItemId")});$(modal).modal("show")}});$(document).on("beforeshow",modal,function(){$(".coral-Popover:visible").popover("hide");
$(".coral-Textfield",modal).each(function(){$(this).val("")});$(".coral-Checkbox-input",modal).each(function(){$(this).prop("checked",$(this).attr("checked")=="checked")})});$(document).on("submit",modal,function(e){e.preventDefault();var $modal=$(modal);$modal.modal("hide");var $title=$("input[name\x3d'./jcr:title']",$modal);var $nameHint=$("input[name\x3d':nameHint']",$modal);if(!$nameHint.val())$nameHint.val($title.val());var url;if(actionPath)url=actionPath;else url=$modal.attr("action")+"/";
$.ajax({method:"post",url:Granite.HTTP.externalize(url),data:$modal.serialize()}).done(function(data,textStatus,jqXHR){$modal.remove();var content=$(".foundation-content").adaptTo("foundation-content");content.refresh()}).fail(function(jqXHR){var message=$("#Message",jqXHR.responseText).text();var ui=$(window).adaptTo("foundation-ui");ui.alert(Granite.I18n.get("Error"),message,"error")});actionPath=null})})(window,document,Granite.$,Granite.URITemplate);
(function(window,document,$,Granite){var COMMAND_URL=Granite.HTTP.externalize("/bin/wcmcommand");var preArchiveValue=true;var deleteText;function getDeleteText(){if(!deleteText)deleteText=Granite.I18n.get("Delete");return deleteText}var cancelText;function getCancelText(){if(!cancelText)cancelText=Granite.I18n.get("Cancel");return cancelText}function deletePages(collection,paths,force,checkChildren,bulkDeleteData,archive){var ui=$(window).adaptTo("foundation-ui");ui.wait();var url=COMMAND_URL;var data=
{_charset_:"UTF-8",force:!!force,checkChildren:!!checkChildren,archive:!!archive};if(bulkDeleteData){url=bulkDeleteData.sourceParentPath+".bulkpages.delete";Object.assign(data,bulkDeleteData)}else{data.cmd="deletePage";data.path=paths}$.ajax({url:url,type:"POST",data:data,success:function(){ui.clearWait();var api=collection.adaptTo("foundation-collection");var layoutConfig=collection.data("foundationLayout");if(layoutConfig&&layoutConfig.layoutId==="column"){var previewShown=$("coral-columnview-preview").length>
0;if(previewShown)if(api&&"load"in api){var id=paths[0];if(id){var parentId=id.substring(0,id.lastIndexOf("/"))||"";if(parentId!=="")api.load(parentId)}}Coral.commons.nextFrame(function(){if(api&&"reload"in api)api.reload()});return}if(api&&"reload"in api){api.reload();return}var contentApi=$(".foundation-content").adaptTo("foundation-content");if(contentApi)contentApi.refresh()},error:function(xhr){ui.clearWait();var message=Granite.I18n.getVar($(xhr.responseText).find("#Message")).html();if(xhr.status===
412){ui.prompt(getDeleteText(),message,"notice",[{text:getCancelText()},{text:Granite.I18n.get("Force Delete"),warning:true,handler:function(){deletePages(collection,paths,true,false,bulkDeleteData,preArchiveValue)}}]);return}ui.alert(Granite.I18n.get("Error"),message,"error")}})}function createEl(name){return $(document.createElement(name))}function removeDomainFromPath(path){if(path!==null&&path!==undefined)return path.replace(/^.*\/\/[^\/]+/,"");return path}function getBulkDeleteData(config,collection){var bulkDeleteData;
var exceptPath=[];if(config&&config.activeSelectionCount==="bulk")if(collection&&collection.dataset.foundationSelectionsSelectallMode==="true"){var $collection=$(collection);var paginationAPI=$collection.adaptTo("foundation-collection").getPagination();if(paginationAPI&&paginationAPI.hasNext){$collection.find(".foundation-collection-item:not(.foundation-selections-item)").each(function(){var itemPath=this.dataset.foundationCollectionItemId;if(itemPath)exceptPath.push(itemPath)});bulkDeleteData={sourceParentPath:removeDomainFromPath(collection.dataset.foundationCollectionId),
exceptPath:exceptPath}}}return bulkDeleteData}$(window).adaptTo("foundation-registry").register("foundation.collection.action.action",{name:"cq.wcm.delete",handler:function(name,el,config,collection,selections){var bulkDeleteData=getBulkDeleteData(config,collection);var message=createEl("div");var intro=createEl("p").appendTo(message);if(selections.length===1)intro.text(Granite.I18n.get("You are going to delete the following item:"));else if(bulkDeleteData)intro.text(Granite.I18n.get("You are going to delete all items from {0} path:",
bulkDeleteData.sourceParentPath));else intro.text(Granite.I18n.get("You are going to delete the following {0} items:",selections.length));var list=[];var maxCount=Math.min(selections.length,12);for(var i=0,ln=maxCount;i<ln;i++){var title=$(selections[i]).find(".foundation-collection-item-title").text();list.push(createEl("b").text(title).prop("outerHTML"))}if(selections.length>maxCount)list.push("\x26#8230;");createEl("p").html(list.join("\x3cbr\x3e")).appendTo(message);var archive=createEl("coral-checkbox");
archive.attr("checked",true);archive.attr("name","archive");archive.text(Granite.I18n.get("Do you want to archive pages before deletion? "));archive.appendTo(message);var icon=createEl("coral-icon");icon.attr("icon","infoCircle").appendTo(message);var toolTip=createEl("coral-tooltip");toolTip.attr("target","_prev");toolTip.attr("placement","left");toolTip.attr("variant","info");toolTip.attr("role","tooltip");toolTip.attr("interaction","on");toolTip.text(Granite.I18n.get("Archiving pages on deletion allows restoring pages from, i.e. undoing, delete operation."));
toolTip.appendTo(message);var ui=$(window).adaptTo("foundation-ui");ui.prompt(getDeleteText(),message.html(),"notice",[{text:getCancelText()},{text:getDeleteText(),warning:true,handler:function(){var archiveValue=$(document.body).find("coral-checkbox[name\x3d'archive']")[0].checked;preArchiveValue=archiveValue;var paths=selections.map(function(v){return $(v).data("foundationCollectionItemId")});deletePages($(collection),paths,false,true,bulkDeleteData,archiveValue)}}])}})})(window,document,Granite.$,
Granite);
(function(document,Granite,$){var configs={lock:{cmd:"lockPage"},unlock:{cmd:"unlockPage"}};var lockActionRelation="cq-siteadmin-admin-actions-lockpage-activator";var unlockActionRelation="cq-siteadmin-admin-actions-unlockpage-activator";function setLockStatus(path,action,collection,selection){var config=configs[action];var ui=$(window).adaptTo("foundation-ui");ui.wait();$.ajax({url:Granite.HTTP.externalize("/bin/wcmcommand"),type:"POST",data:{_charset_:"UTF-8",path:path,cmd:config.cmd}}).done(function(){ui.clearWait();var api=
collection.adaptTo("foundation-collection");if(api&&"reload"in api){api.reload();if(collection.is("coral-columnview")){updateLockingRelationInSelection(action,selection);collection.trigger("foundation-selections-change")}return}var contentApi=$(".foundation-content").adaptTo("foundation-content");if(contentApi)contentApi.refresh()}).fail(function(xhr){ui.clearWait();var title=Granite.I18n.get("Error");var message=Granite.I18n.getVar($(xhr.responseText).find("#Message").html());ui.alert(title,message,
"error")})}function updateLockingRelationInSelection(action,selection){var quickActions=$(selection).find(".foundation-collection-quickactions");var relations=$(quickActions).data("foundationCollectionQuickactionsRel")||"";relations=action==="lock"?relations.replace(lockActionRelation,unlockActionRelation):relations.replace(unlockActionRelation,lockActionRelation);$(quickActions).data("foundationCollectionQuickactionsRel",relations)}var registry=$(window).adaptTo("foundation-registry");registry.register("foundation.collection.action.action",
{name:"cq.wcm.lock",handler:function(name,el,config,collection,selections){var path=$(selections[0]).data("foundationCollectionItemId");setLockStatus(path,"lock",$(collection),$(selections[0]))}});registry.register("foundation.collection.action.action",{name:"cq.wcm.unlock",handler:function(name,el,config,collection,selections){var path=$(selections[0]).data("foundationCollectionItemId");setLockStatus(path,"unlock",$(collection),$(selections[0]))}})})(document,Granite,Granite.$);
(function(window,document,$,URITemplate,CUI){$(window).adaptTo("foundation-registry").register("foundation.collection.action.action",{name:"cq.wcm.open",handler:function(name,el,config,collection,selections){if(CUI.util.isTouch)$.cookie("cq-authoring-mode","TOUCH",{path:config.data.cookiePath,expires:7});var winMode=$("meta[name\x3d'user.preferences.winmode']",document.head).prop("content");if(winMode==="single"){var first=selections[0];if(first){var url=URITemplate.expand(config.data.href,{item:$(first).data("foundation-collection-item-id")});
window.location.href=url}}else selections.forEach(function(item){if(config.data.href!=null){var url=URITemplate.expand(config.data.href,{item:$(item).data("foundation-collection-item-id")});url=url.startsWith("/")===true?url:"/"+url;window.open(url,undefined,"noopener")}})}})})(window,document,Granite.$,Granite.URITemplate,CUI);
(function(window,document,Granite,$){var ui=$(window).adaptTo("foundation-ui"),rel=".cq-wcm-pagethumbnail",$assetPicker,$pageThumbnail;var contextPath=Granite.HTTP.getContextPath();$(document).on("reset","form",function(){var component=$(this).find(rel);restoreImage(component);clearValue(component);toggleRevertButton(component,false);return false});$(document).on("coral-fileupload:fileadded",".cq-wcm-pagethumbnail .cq-wcm-fileupload",function(e){var fileUploadEl=$(this);var fileUpload=e.originalEvent.target;
var file=e.originalEvent.detail.item.file;var component=fileUploadEl.closest(".cq-wcm-pagethumbnail");wait(component);var base=component.closest("form").attr("action");fileUploadEl.one("fileuploadload",function(e){var status=$(e.content).find("#Status").text();e.fileUpload._internalOnUploadLoad(e,e.item,status,e.content)}).one("coral-fileupload:load",function(e){var url=base+function(){var name=fileUpload.name;if(name.indexOf(".")===0)name=name.substring(1);return name}();clearWait(component,url+
"?ck\x3d"+(new Date).getTime());fileUploadEl.removeClass("disabled");setValue(component,fileUpload.name.replace(".sftmp","@MoveFrom"),url)});fileUpload.action=base;fileUpload.upload(file.name);return true});function generate(component){var activator=component.find(".cq-wcm-pagethumbnail-activator").prop("disabled",true);wait(component);var path=component.data("cqWcmPagethumbnailPath");var isTemplate=component.data("isTemplate")||false;var dest=isTemplate?"thumbnail.png.sftmp":"file.sftmp";var pgen=
new CQ.Siteadmin.PagePreview;pgen.generatePreview(path,dest,isTemplate,function(data){if(isTemplate)setValue(component,"./thumbnail.png@MoveFrom",component.closest("form").attr("action")+"/"+dest);else setValue(component,"./image/file@MoveFrom",component.closest("form").attr("action")+"/image/"+dest);clearWait(component,data);activator.prop("disabled",false)})}function wait(component){ui.wait(component.find(".cq-wcm-pagethumbnail-image").parent()[0])}function clearWait(component,src){var $currentImage=
component.find(".cq-wcm-pagethumbnail-image");if(isCacheEmpty(component))cacheCurrentImage(component,$currentImage);replaceImage($currentImage,src);toggleRevertButton(component,true);ui.clearWait()}var THUMBNAIL_DATA_KEY="cq-wcm-pagethumbnail.internal.original";function isCacheEmpty(component){return!component.data(THUMBNAIL_DATA_KEY)}function cacheCurrentImage(component,$currentImage){if($currentImage.length)component.data(THUMBNAIL_DATA_KEY,$currentImage)}function replaceImage($currentImage,newSrc){$currentImage.replaceWith($('\x3cimg class\x3d"cq-wcm-pagethumbnail-image"\x3e').prop("src",
newSrc))}function restoreImage(component){component.find(".cq-wcm-pagethumbnail-image").replaceWith(component.data(THUMBNAIL_DATA_KEY))}function toggleRevertButton(component,show){component.find('button[type\x3d"reset"]')[0].hidden=!show}function setValue(component,name,url,isTemplateParam){var hidden,hiddenDelete,isTemplate=typeof isTemplateParam!=="undefined"?isTemplateParam:false;hidden=component.find('input[name\x3d"'+name+'"]');hiddenDelete=component.find(".cq-wcm-pagethumbnail-hidden-delete");
if(hidden.length===0){hidden=component.find(".cq-wcm-pagethumbnail-hidden");if(!hidden.length)hidden=$('\x3cinput class\x3d"cq-wcm-pagethumbnail-hidden" type\x3d"hidden"\x3e').appendTo(component)}if(hiddenDelete.length===0&&name.match("fileReference$"))if(isTemplate)$('\x3cinput class\x3d"cq-wcm-pagethumbnail-hidden-delete" type\x3d"hidden" name\x3d"./thumbnail.png@Delete" value\x3d""\x3e').appendTo(component);else $('\x3cinput class\x3d"cq-wcm-pagethumbnail-hidden-delete" type\x3d"hidden" name\x3d"./image/file@Delete" value\x3d""\x3e').appendTo(component);
else hiddenDelete.remove();hidden.prop("name",name).val(url.replace(new RegExp("^"+contextPath),"").replace("_jcr_content","jcr:content")).prop("disabled",false)}function clearValue(component){component.find(".cq-wcm-pagethumbnail-hidden").remove()}function selectThumbnailClickEvent(self,event){event.preventDefault();var control=$(this);var state=getThumbnailPickerState(control);if(state.loading)return;if(state.el)if(state.open){state.api.cancel();cancelThumbnailPicker(control,state)}else showThumbnailPicker(self,
control,state);else{var src="/mnt/overlay/granite/ui/content/coral/foundation/form/pathfield/picker.html"+"?_charset_\x3dutf-8\x26path\x3d%2fcontent%2fdam\x26root\x3d%2fcontent%2fdam\x26filter\x3dhierarchyNotFile\x26selectionCount\x3dsingle";if(!src)return;state.loading=true;$.ajax({url:src,cache:false}).then(function(html){return $(window).adaptTo("foundation-util-htmlparser").parse(html)}).then(function(fragment){return $(fragment).children()[0]}).then(function(pickerEl){state.loading=false;state.el=
pickerEl;state.api=$(pickerEl).adaptTo("foundation-picker");showThumbnailPicker(self,control,state)},function(){state.loading=false})}}function getThumbnailPickerState(control){var KEY_STATE="thumbnail-picker.internal.state";var state=control.data(KEY_STATE);if(!state){state={el:null,open:false,loading:false};control.data(KEY_STATE,state)}return state}function showThumbnailPicker(self,control,state){state.api.attach(this);state.api.pick(control[0],[]).then(function(selections){state.api.detach();
state.open=false;handleThumbnailPickerSelections(self,selections)},function(){cancelThumbnailPicker(control,state)});if("focus"in state.api)state.api.focus(last);else state.el.focus();state.open=true}function cancelThumbnailPicker(control,state){state.api.detach();state.open=false}function handleThumbnailPickerSelections(self,selections){var API_ASSETS="/api/assets";var ASSETS_PREFIX="/content/dam";var assetPath=selections[0].value;var jsonAssetPath=assetPath.substring(ASSETS_PREFIX.length);$.get(""+
API_ASSETS+jsonAssetPath+".json").done(function(data){if(!data.properties||!data.properties.metadata||!data.properties.metadata["dc:format"])return;self.trigger({type:"cq-assetpicker",path:assetPath})})}$(document).on("ready",function(e){$pageThumbnail=$(e.currentTarget).find(rel);$pageThumbnail.on("click",".js-browse-activator",function(event){selectThumbnailClickEvent($pageThumbnail,event)})});$(document).on("click",".cq-wcm-pagethumbnail-activator",function(e){generate($(this).closest(".cq-wcm-pagethumbnail"))});
$(document).on("cq-assetpicker",".cq-wcm-pagethumbnail",function(e){var component=$(e.target);var isTemplate=component.data("isTemplate")||false;if(isTemplate)setValue(component,"./jcr:content/fileReference",e.path,true);else setValue(component,"./image/fileReference",e.path);clearWait(component,e.path)})})(window,document,Granite,Granite.$);
(function(window,document,$,Granite){var REPLICATE_URL=Granite.HTTP.externalize("/bin/replicate");var QUICKPUBLISH_TITLE=Granite.I18n.get("Quick Publish");var PUBLISH_TEXT=Granite.I18n.get("Publish");var CANCEL_TEXT=Granite.I18n.get("Cancel");var ERROR_TEXT=Granite.I18n.get("Error");var DEFAULT_REPLICATION_AGENT_ID="publish";function activatePagesAndItsReferences(config,collection,selections){var ui=$(window).adaptTo("foundation-ui");ui.wait();var paths=selections.map(function(v){var item=$(v);var refPath=
item.data("checkReferencesPath");if(!refPath)refPath=item.children().data("checkReferencesPath");if(refPath)return refPath.split(",");return item.data("foundationCollectionItemId")});if(!paths.length)return;paths=removeDuplicatesInArray(paths);var referenceSrc=config.data.referenceSrc;if(!referenceSrc.startsWith("http://")&&!referenceSrc.startsWith("https://")){var referencePromise=$.ajax({url:Granite.URITemplate.expand(referenceSrc,{path:paths}),"type":"POST",cache:false,dataType:"json"}).fail(function(xhr){var message=
Granite.I18n.getVar($(xhr.responseText).find("#Message").html());ui.alert(ERROR_TEXT,message,"error")});referencePromise.done(function(json){if(json.assets.length){for(var i=0;i<json.assets.length;i++){var reference=json.assets[i];paths.push(reference.path)}paths=removeDuplicatesInArray(paths)}$.ajax({url:REPLICATE_URL,type:"POST",data:{_charset_:"utf-8",cmd:"Activate",path:paths,agentId:DEFAULT_REPLICATION_AGENT_ID}}).always(function(){ui.clearWait()}).done(function(){var api=$(collection).adaptTo("foundation-collection");
if(api&&"reload"in api){api.reload();ui.notify(null,getSuccessMessage(selections));return}var contentApi=$(".foundation-content").adaptTo("foundation-content");if(contentApi)contentApi.refresh();ui.notify(null,getSuccessMessage(selections))}).fail(function(xhr){var title=Granite.I18n.get("Error");var message=Granite.I18n.getVar($(xhr.responseText).find("#Message").html());ui.alert(title,message,"error")})})}}function createEl(name){return $(document.createElement(name))}function getSuccessMessage(selections){var successMessage=
Granite.I18n.get("The {0} pages and their references have been published",selections.length);if(selections.length===1)successMessage=Granite.I18n.get("The page and their references have been published");return successMessage}function removeDuplicatesInArray(anyArray){return anyArray.sort().filter(function(item,pos,ary){return!pos||item!=ary[pos-1]})}$(window).adaptTo("foundation-registry").register("foundation.collection.action.action",{name:"cq.wcm.quickpublish",handler:function(name,el,config,collection,
selections){var message=createEl("div");var intro=createEl("p").appendTo(message);if(selections.length===1)intro.text(Granite.I18n.get("The page and their references will be published."));else intro.text(Granite.I18n.get("The {0} pages and their references will be published.",selections.length));var ui=$(window).adaptTo("foundation-ui");ui.prompt(QUICKPUBLISH_TITLE,message.html(),"notice",[{text:CANCEL_TEXT},{text:PUBLISH_TEXT,primary:true,handler:function(){activatePagesAndItsReferences(config,collection,
selections)}}])}})})(window,document,Granite.$,Granite);
(function(window,document,$,URITemplate){var replicateURL=Granite.HTTP.externalize("/bin/replicate");var successMessage=Granite.I18n.get("The item has been published");var DEFAULT_REPLICATION_AGENT_ID="publish";$(window).adaptTo("foundation-registry").register("foundation.collection.action.action",{name:"cq.wcm.publish",handler:function(name,el,config,collection,selections){var ui=$(window).adaptTo("foundation-ui");ui.wait();var paths=selections.map(function(v){var item=$(v);var refPath=item.data("checkReferencesPath");
if(!refPath)refPath=item.children().data("checkReferencesPath");if(refPath)return refPath.split(",");return item.data("foundationCollectionItemId")});if(!paths.length)return;paths=[].concat.apply([],paths);config.data.referenceSrc=config.data.referenceSrc.startsWith("/")?config.data.referenceSrc:"/"+config.data.referenceSrc;var referencePromise=$.ajax({url:URITemplate.expand(config.data.referenceSrc,{path:paths}),"type":"POST",cache:false,dataType:"json"});referencePromise.done(function(json){if(json.assets.length===
0)$.ajax({url:replicateURL,type:"POST",data:{_charset_:"utf-8",cmd:"Activate",path:paths,agentId:DEFAULT_REPLICATION_AGENT_ID}}).always(function(){ui.clearWait()}).done(function(){var api=$(collection).adaptTo("foundation-collection");if(api&&"reload"in api){api.reload();ui.notify(null,successMessage);return}var contentApi=$(".foundation-content").adaptTo("foundation-content");if(contentApi)contentApi.refresh();ui.notify(null,successMessage)}).fail(function(xhr){var title=Granite.I18n.get("Error");
var message=Granite.I18n.getVar($(xhr.responseText).find("#Message").html());ui.alert(title,message,"error")});else{sessionStorage.setItem("document.referrer",window.location.href);window.location.href=URITemplate.expand(config.data.wizardSrc,{item:paths})}});referencePromise.fail(function(xhr){ui.clearWait();var title=Granite.I18n.get("Error");var message=Granite.I18n.get("Failed to retrieve references for selected items.");ui.alert(title,message,"error")})}});$(document).on("foundation-contentloaded",
function(e){var message=sessionStorage.getItem("cq-page-published-message");if(message!==null){sessionStorage.removeItem("cq-page-published-message");var ui=$(window).adaptTo("foundation-ui");ui.notify(null,Granite.I18n.getVar(message))}})})(window,document,Granite.$,Granite.URITemplate);
(function(window,$,URITemplate){var ui=$(window).adaptTo("foundation-ui");var treeURL=Granite.HTTP.externalize("/bin/wcm/siteadmin/tree.json");var replicateURL=Granite.HTTP.externalize("/bin/replicate");var NUM_CHILDREN_CHECK=20;var successMessage=Granite.I18n.get("The item has been unpublished");var DEFAULT_REPLICATION_AGENT_ID="publish";function unpublish(paths,collection){$.ajax({url:replicateURL,type:"POST",data:{_charset_:"utf-8",cmd:"Deactivate",path:paths,agentId:DEFAULT_REPLICATION_AGENT_ID}}).always(function(){ui.clearWait()}).done(function(){var api=
collection.adaptTo("foundation-collection");if(api&&"reload"in api){api.reload();ui.notify(null,successMessage);return}var contentApi=$(".foundation-content").adaptTo("foundation-content");if(contentApi)contentApi.refresh();ui.notify(null,successMessage)}).fail(function(xhr){var title=Granite.I18n.get("Error");var message=Granite.I18n.getVar($(xhr.responseText).find("#Message").html());ui.alert(title,message,"error")})}function countReferences(config,paths){return $.ajax({url:URITemplate.expand(config.data.referenceSrc,
{path:paths,predicate:"wcmcontent"}),"type":"POST",cache:false,dataType:"json"}).then(function(json){return json.pages.reduce(function(memo,value){if(value.published&&(value.isPage===true||value.isPage==="true")&&value.path!==value.srcPath)return memo+1;return memo},0)})}function countChildren(paths){var total=0;var promises=paths.map(function(path){return $.ajax({url:treeURL,data:{path:path,ncc:NUM_CHILDREN_CHECK},cache:false,dataType:"json"}).then(function(children){total+=children.length;children.forEach(function(child){if(!child.leaf)total+=
child.sub});return true},function(){return $.when(false)})});return $.when.apply(null,promises).then(function(){if(total>0)return total;var allOK=Array.prototype.every.call(arguments,function(status){return status});if(allOK)return total;return $.Deferred().reject().promise()})}$(window).adaptTo("foundation-registry").register("foundation.collection.action.action",{name:"cq.wcm.unpublish",handler:function(name,el,config,collection,selections){var ui=$(window).adaptTo("foundation-ui");ui.wait();var paths=
selections.map(function(v){var item=$(v);return item.data("foundationCollectionItemId")});if(!paths.length)return;paths=[].concat.apply([],paths);var countChildrenPromise=countChildren(paths);var countRefsPromise=countReferences(config,paths);countChildrenPromise.fail(function(){ui.clearWait();var title=Granite.I18n.get("Error");var message=Granite.I18n.get("Failed to retrieve child items for selected items.");ui.alert(title,message,"error")});countRefsPromise.fail(function(){ui.clearWait();var title=
Granite.I18n.get("Error");var message=Granite.I18n.get("Failed to retrieve references for selected items.");ui.alert(title,message,"error")});$.when(countChildrenPromise,countRefsPromise).then(function(countChildren,countRefs){if(countRefs===0&&countChildren===0){unpublish(paths,$(collection));return}ui.clearWait();if(countChildren>NUM_CHILDREN_CHECK)countChildren=NUM_CHILDREN_CHECK+"+";var messageRefs=countRefs===0?"":Granite.I18n.get("Selected items are referenced by {0} item(s).",countRefs);var messageChildren=
countChildren===0?"":Granite.I18n.get("Upon unpublishing, other {0} child item(s) will get unpublished.",countChildren);var message=messageRefs+" \x3cbr\x3e "+messageChildren;ui.prompt(Granite.I18n.get("Unpublish"),message,"notice",[{text:Granite.I18n.get("Cancel")},{text:Granite.I18n.get("Continue"),warning:true,handler:function(){ui.wait();unpublish(paths,$(collection))}}])})}})})(window,Granite.$,Granite.URITemplate);
(function(window,$,URITemplate){$(window).adaptTo("foundation-registry").register("foundation.collection.action.action",{name:"cq.wcm.export.excel",handler:function(name,el,config,collection,selections){var id=collection?collection.dataset.foundationCollectionId:undefined;var url=URITemplate.expand(encodeURIComponent(config.data.href),{id:id,item:selections.map(function(item){return item.dataset.foundationCollectionItemId})});var searchQuery=$("[data-current-query]").data("currentQuery");if(searchQuery)url=
url+"?"+searchQuery;window.open(url)}})})(window,Granite.$,Granite.URITemplate);
(function(window,document,$,URITemplate){$(window).adaptTo("foundation-registry").register("foundation.collection.action.action",{name:"cq.wcm.move",handler:function(name,el,config,collection,item){var ui=$(window).adaptTo("foundation-ui");ui.wait();var path=$(item).data("foundationCollectionItemId");var infoPromise=$.ajax({url:URITemplate.expand(config.data.infoSrc,{path:path}),"type":"GET",cache:false,dataType:"json"});infoPromise.done(function(json){if(json.isInLaunch){ui.clearWait();var title=
Granite.I18n.get("Error");var message=Granite.I18n.get("The page is the source root of a launch and the launch will become orphan after this action. The move operation is denied.");ui.alert(title,message,"error")}else{sessionStorage.setItem("document.referrer",window.location.href);if(!config.data.href.startsWith("/")&&!config.data.href.startsWith("http"))console.error("Redirect after move action was abandoned. Misconfigured redirection target.");else window.location.href=URITemplate.expand(config.data.href,
{item:path})}});infoPromise.fail(function(xhr){ui.clearWait();var title=Granite.I18n.get("Error");var message=Granite.I18n.get("Failed to retrieve launches information for selected item.");ui.alert(title,message,"error")})}})})(window,document,Granite.$,Granite.URITemplate);