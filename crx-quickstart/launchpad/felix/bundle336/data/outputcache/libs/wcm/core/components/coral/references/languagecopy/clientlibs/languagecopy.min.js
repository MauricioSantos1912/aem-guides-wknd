(function(q,d){var E,J,K;d.ready(function(){d.$root.on(d.EVENT_SELECTALL,function(a,b){d.$detailToolbars.find(".detail-toolbar.active coral-accordion-item").attr("selected",!1);"languageCopy"===d.$root.data("type")&&(L(b.checked),d.$detailToolbars.find(".detail-toolbar.update").toggleClass("active",b.checked).toggleClass("hidden",!b.checked),d.triggerResize({detail:!0}),d.$detailList.find('section[data-path\x3d"'+Granite.References.getReferencePath()+'"]').find("coral-checkbox").remove())});d.$detail.on("foundation-contentloaded.data-api",
function(){if("languageCopy"===d.$root.data("type")){var a=d.$detailToolbars.find(".detail-toolbar.start"),b=a.find("form");d.$detailToolbars.find(".detail-toolbar.update").find("form");E=a.data("translationprojectworkflowmodel");J=a.data("translationworkflowmodel");K=Granite.HTTP.externalize(a.data("projectdetails"));a=d.$detail.find("coral-select.languages").get(0);Coral.commons.ready(a,function(c){for(var e=c.items.getAll(),g=0,f=0;f<e.length;f++)0<d.$detail.find("[data-language-code\x3d'"+e[f].value+
"']").length&&(g+=1,c.items.remove(e[f]));1==g&&(d.$detailHeader.find("coral-checkbox input").hide(),d.$detailHeader.find("coral-checkbox span").hide())});L();a=b.find("button[data-role\x3d'submit']");0<a.length&&(CustomElements.upgradeAll(b.get(0)),a.data("defaulttext",a.get(0).label.innerHTML))}});var L=function(a){var b=d.$detailToolbars.find(".detail-toolbar.start");a?b.toggleClass("active",!a).toggleClass("hidden",a):(a=b.find("form").find("coral-select[name\x3d'languages']").get(0),Coral.commons.ready(a,
function(c){var e=c?c.items.length:0;1==e&&M(!0);e=c?c.items.length:0;b.toggleClass("active",0<e).toggleClass("hidden",0==e);d.triggerResize({detail:!0})}))},A=function(a,b){$(window).adaptTo("foundation-ui").notify("",a,b)};d.$detailToolbars.on("coral-accordion:change",".detail-toolbar.start coral-accordion",function(a){B()});var T=function(a,b,c){$(".detail-toolbar.start coral-accordion coral-accordion-item-label").click();d.showSpinner();var e=$(".detail-toolbar.start"),g=e.find("form"),f=g.find("[name\x3d'projectType']").val(),
r=g.find("coral-select[name\x3d'project']").get(0).selectedItem,n=g.find("[name\x3d'projectTitle']").val();"add_existing"===f&&(b=r.value,n=r.innerText.trim());for(var l=[],m,p=0,z=[],C=e.data("workflowmodel"),F=!!g.find("input[name\x3d'deep']").prop("checked"),y=d.getReferencePath(),t="",w="",u="add_new_multi_lang"===f||"add_existing"===f,G=a.length,k=0;k<a.length;k++)0!=t.length&&(t+=","),t+=a[k].value,0!=w.length&&(w+=","),w+=a[k].textContent;for(k=0;k<a.length;k++)if(!(u&&0<k)){e=a[k].value;var H=
a[k].textContent,v=$.Deferred().resolve();u?(v.languageCodeList=t,v.languageTitle=w):(v.languageCode=e,v.languageTitle=H);v=v.then(function(){var h={_charset_:"utf-8",":status":"browser",payloadType:"JCR_PATH",model:C,createNonEmptyAncestors:!0,deep:F,payload:y,projectFolderPath:b,masterProjectPath:c,projectFolderLanguageRefCount:G,translationWorkflowModel:E};u?h.languageList=v.languageCodeList:h.language=v.languageCode;h.projectTitle=n;if("add_existing"===f&&b){h.projectType="add_existing";var I=
Granite.I18n.get('Translation of "{0}" using existing project "{1}" in "{2}"',[h.payload,h.projectFolderPath,u?w:H]);m={title:n,data:h}}else"add_structure_only"===f?(h.projectType="add_structure_only",delete h.translationWorkflowModel,I=Granite.I18n.get('Copy Structure "{0}" ',[h.payload])):(h.projectType=f,l.push({data:h}),I=Granite.I18n.get('Translation of "{0}" using new project "{1}" in "{2}"',[h.payload,h.projectTitle,u?w:H]));h.workflowTitle=I;var N=$.Deferred();$.post("/var/workflow/instances",
h,function(){$.each(l,function(O,P){if(P.data===h)return p++,u||z.push(P.data.language.toUpperCase()),!1});if(u||k===a.length){var x=[];0<p&&(1===p?x.push(Granite.I18n.get("Translation project created ({0})",[t])):x.push(Granite.I18n.get("{0} translation projects created ({1})",[p,t])));m&&m.data===h&&(m.data.deep?x.push(Granite.I18n.get("Selected pages have been added to translation project '{0}'",[m.title])):x.push(Granite.I18n.get("Selected page has been added to translation project '{0}'",[m.title])));
if(x.length)if(1===x.length)A(x[0],"info");else{var Q=0;x.forEach(function(O){setTimeout(function(){A(O,"info")},Q);Q+=3E3})}}}).fail(function(){A(Granite.I18n.get("Failed to start the language copy creation workflow for language {0}",[t]),"error")}).always(function(){N.resolve()});return N.promise()})}v.then(function(){setTimeout(function(){d.$detailToolbars.find(".detail-toolbar.active coral-accordion-item").attr("selected",!1);d.refreshDetail()},400)})},R=function(a,b,c,e,g){var f="",r=Granite.HTTP.externalize("/content/projects");
"add_new"===b&&1<c.length?$.post(r,{":operation":"projects:createfolder","./jcr:title":a,parentPath:"/content/projects",folderthumbnailurl:"/libs/cq/core/content/projects/templates/translation-project/thumbnail.png",_charset_:"utf-8"}).then(function(n){f=$(n).find(".cq-projects-admin-createfolder-open").attr("href");n=Granite.HTTP.externalize("/projects.html")+"/";0==f.indexOf(n)&&(f=f.substr(n.length-1));g(c,f,e)}):"add_new_multi_lang"===b||"add_new"===b&&1===c.length?g(c,f,e):g(c,f,"")};d.$detailToolbars.on("click",
".detail-toolbar.start coral-accordion button[data-role\x3d'submit']",function(a){if("languageCopy"===d.$root.data("type")){var b=$(".detail-toolbar.start");a=b.find("form");b=b.find("coral-select[name\x3d'languages']").get(0).selectedItems;var c=a.find("[name\x3d'projectType']").val(),e=a.find("[name\x3d'masterProject']").val();0<b.length&&(a=a.find("[name\x3d'projectTitle']").val(),R(a,c,b,e,T))}});d.$detailToolbars.on("change","coral-select.languages",function(a){M(!1);B();window.setTimeout(function(){d.$root.trigger(d.EVENT_RESIZE)},
1)});d.$detailToolbars.on("change","coral-select.projectType",function(a){a=$(a.currentTarget).parents(".detail-toolbar");a.find(".projectTitle").attr("hidden",!("add_new"===this.value||"add_new_multi_lang"===this.value)).find("[name\x3d'projectTitle']").val("");var b=a.find("[name\x3d'project']");b.closest(".coral-Form-fieldwrapper").attr("hidden","add_existing"!==this.value);a.find("[name\x3d'masterProject']").closest(".coral-Form-fieldwrapper").attr("hidden",!("add_new"===this.value||"add_new_multi_lang"===
this.value));if(b=b.get(0))b.value="";a.hasClass("update")?D(!0):B(!0)});$(q).on("keyup",".detail-toolbar.start [name\x3d'projectTitle']",function(a){B()});$(q).on("change",".detail-toolbar [name\x3d'project']",function(a){$(a.currentTarget).parents(".detail-toolbar").hasClass("update")?D(!0):B(!0)});var M=function(a){var b=q.querySelector("coral-select.languages").items;if(a)1==b.length&&"select_all_roots"==b.getAll()[0].value&&$("coral-select.languages").find("coral-select-item[value\x3d'select_all_roots']").remove();
else{a=q.querySelector("coral-select.languages").selectedItems;for(var c=!1,e=0;e<a.length;e+=1)if("select_all_roots"==a[e].getAttribute("value")){c=!0;break}c?($("coral-select.languages").find("coral-select-item").attr("selected",!0),$("coral-select.languages").find("coral-select-item[value\x3d'select_all_roots']").attr("selected",!1),$("coral-select.languages").find("coral-select-item[value\x3d'select_all_roots']").attr("disabled",!0)):($("coral-select.languages").find("coral-select-item[value\x3d'select_all_roots']").attr("disabled",
!1),1==b.length-a.length&&$("coral-select.languages").find("coral-select-item[value\x3d'select_all_roots']").attr("disabled",!0))}},D=function(){var a=d.$detailToolbars.find(".detail-toolbar.update form"),b=$(".detail-list").find("section[data-type\x3dlanguageCopy] :checkbox:checked").length,c=a.find("[name\x3d'projectType']").val(),e=a.find(".projectTitle"),g=a.find("[name\x3d'project']").get(0);if(g){var f=g.items.getAll();null===g.selectedItem&&0<f.length&&(g.value=f[0].value)}else g={};e.find(".fieldDescription").hide();
1<b&&e.find(".fieldDescription_"+c).show();d.triggerResize({detail:!0});if(a=a.find("button[data-role\x3d'submit']").get(0))b=0<b&&("add_new"===c&&""!==e.find("[name\x3d'projectTitle']").val()||"add_new_multi_lang"===c&&""!==e.find("[name\x3d'projectTitle']").val()||"add_existing"===c&&null!==g.selectedItem||"add_structure_only"===c),a.disabled=!b},B=function(){var a=d.$detailToolbars.find(".detail-toolbar.start form"),b=a.find("[name\x3d'project']").get(0);if(b){var c=b.items.getAll();null===b.selectedItem&&
0<c.length&&(b.value=c[0].value)}else b={};d.triggerResize({detail:!0});var e=a.find("coral-select[name\x3d'languages']").get(0).selectedItems.length;c=a.find("[name\x3d'projectType']").val();var g=a.find(".projectTitle");g.find(".fieldDescription").hide();1<e&&g.find(".fieldDescription_"+c).show();b=0<e&&("add_new"===c&&""!==g.find("[name\x3d'projectTitle']").val()||"add_new_multi_lang"===c&&""!==g.find("[name\x3d'projectTitle']").val()||"add_existing"===c&&null!==b.selectedItem||"add_structure_only"===
c);a=a.find("button[data-role\x3d'submit']");if(e=a.get(0))e.disabled=!b,e.label.innerHTML="add_existing"===c?a.data("oppositetext"):a.data("defaulttext")},S=function(a,b){if(!a||0==a.length){var c=$(".cq-siteadmin-admin-childpages.foundation-collection").find(".foundation-selections-item");0<c.length&&(a=c.eq(0).data("item-title"))}b=parseInt(b);return isNaN(b)?Granite.I18n.get("Translation review {0}",a):(b++,Granite.I18n.get("Translation review {0} {1}",[a,b]))};d.$detailToolbars.on("click",".detail-toolbar.update coral-accordion button[data-role\x3d'submit']",
function(a){if("languageCopy"===d.$root.data("type")){var b=$(".detail-toolbar.update").find("form");a=$(".detail-list").find("section[data-type\x3dlanguageCopy] input:checked");var c=b.find("[name\x3d'projectType']").val(),e=b.find("[name\x3d'masterProject']").val();0<a.length&&(b=b.find("[name\x3d'projectTitle']").val(),R(b,c,a,e,U))}});var U=function(a,b,c){$(".detail-toolbar.update coral-accordion coral-accordion-item-label").click();d.showSpinner();var e=$(".detail-toolbar.update"),g=e.find("form");
if("languageCopy"===d.$root.data("type")){var f=e.find("form").find("[name\x3d'projectType']").val();if(null==f||0==f.length)f="update";var r="";"add_existing"===f?(a=g.find("coral-select[name\x3d'project']").get(0),b=a.value,r=a.selectedItem.innerText.trim()):r=g.find("[name\x3d'projectTitle']").val();a=$(".detail-list").find("section[data-type\x3dlanguageCopy] input:checked");var n=a.length,l={_charset_:"utf-8",":status":"browser",payloadType:"JCR_PATH",model:e.data("workflowmodel"),projectTitle:r,
deep:g.find("input[name\x3d'deep']").prop("checked"),projectType:f,projectFolderPath:b,masterProjectPath:c,projectFolderLanguageRefCount:n,translationWorkflowModel:E},m="",p=b="",z="add_new_multi_lang"===f||"add_existing"===f;for(c=0;c<a.length;c++)0!=m.length&&(m+=";"),f=$(a[c]).closest("section"),e=f.data("path"),m+=e,e=f.data("language-code-title"),0!=b.length&&(b+=","),b+=e,f=f.data("language-code"),0!=p.length&&(p+=","),p+=f;var C=$.Deferred().resolve(),F=0;a.each(function(){if(!(z&&0<F)){F++;
var y=$(this).closest("section"),t=y.data("source-language-code"),w=y.data("language-code"),u=y.data("language-code-title"),G=y.data("launch-count");C=C.then(function(){l.payload=y.data("path");l.language=t;l.projectTitle=r;l.destinationLanguage=w;z&&(l.sourcePathList=m,l.languageList=p);l.workflowLaunchTitle=S(z?"%s":u,G);var k=$.Deferred();$.post("/var/workflow/instances",l).fail(function(){A(Granite.I18n.get("Failed to start the language copy update workflow for language {0}",[z?p:languageCode]),
"error")}).always(function(){k.resolve()});return k.promise()})}});C.then(function(){setTimeout(function(){d.updateMainCheckbox();d.$detailList.data("multiselect",!1);d.$detailToolbars.find(".detail-toolbar.active coral-accordion-item").attr("selected",!1);d.refreshDetail()},1E3)})}};d.$detailToolbars.on("coral-accordion:change",".detail-toolbar.update coral-accordion",function(a){D()});d.$detailList.on("click","section",function(){D()});$(q).on("keyup",".detail-toolbar.update [name\x3d'projectTitle']",
function(a){D()});$(q).on("click",".detail section[data-type\x3dlanguageCopy] .gotoprojects",function(){var a=$(this).closest("section").data("translation-project");a&&window.open(K+a)});$(q).on("click",".detail section[data-type\x3dlanguageCopy] .open-languagecopy-launch-page",function(){var a=$(this).closest("section"),b=a.data("launch-path");a=a.data("path");if(b){var c=Granite.HTTP.externalize("/bin/wcmcommand");window.open(c+"?cmd\x3dopen"+("\x26path\x3d"+b+a))}});$(q).on("click",".detail section[data-type\x3dlanguageCopy] .promote-languagecopy-launch",
function(){var a=$(this).closest("section");if(a=a.data("launch-path")+a.data("path"))location.href=Granite.HTTP.externalize("/libs/wcm/core/content/sites/promotelaunchwizard.html"+a)});$(q).on("click",".detail section[data-type\x3dlanguageCopy] .update",function(a){var b=$(this).closest("section");a={_charset_:"utf-8",":status":"browser",payloadType:"JCR_PATH",model:$(".detail-toolbar.update").data("workflowmodel"),deep:!1,language:b.data("source-language-code"),payload:b.data("path"),projectType:"update",
workflowLaunchTitle:S("","")};(b=b.data("translation-project"))?(a.projectPath=b,a.translationWorkflowModel=E):a.translationWorkflowModel=J;$.post("/var/workflow/instances",a).done(function(){setTimeout(function(){d.$detailToolbars.find(".detail-toolbar.active coral-accordion-item").attr("selected",!1);d.refreshDetail()},1E3)}).fail(function(){A(Granite.I18n.get("Failed to start the language copy update workflow for language {0}",[languageCode]),"error")})})})})(document,Granite.References);